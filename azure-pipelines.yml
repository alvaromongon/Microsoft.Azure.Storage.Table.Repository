# Built-test-staging-prod pipeline

# Only run against master
trigger:
- master

# Don't run against PRs
pr: none

stages:
- stage: build
  jobs:
  - job: run_build
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - script: dotnet restore
    - task: DotNetCoreCLI@2
      displayName: Build
      inputs:
        command: build
        projects: '**/*.csproj'
        arguments: '--configuration $(buildConfiguration)'

- stage: unit_tests
  dependsOn: build
  jobs:
  - job: run_tests
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - task: DotNetCoreCLI@2
      displayName: UnitTests
      inputs:
        command: test
        projects: '**/tests/**/*UnitTests.csproj'
        arguments: '--configuration $(buildConfiguration)'
    
- stage: publish_artifacts
  dependsOn: unit_tests
  jobs:
  - job: deploy_staging
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - task: CopyFiles@2
      displayName: 'Copy *settings.json to: $(Build.ArtifactStagingDirectory)'
      inputs:
        Contents: '**/*settings.json'
        TargetFolder: '$(Build.ArtifactStagingDirectory)'

    - task: CopyFiles@2
      displayName: 'Copy *runtimeconfig.json to: $(Build.ArtifactStagingDirectory)'
      inputs:
        Contents: '**/*runtimeconfig.json'
        TargetFolder: '$(Build.ArtifactStagingDirectory)'

    - script: dotnet publish --output $(Build.ArtifactStagingDirectory)

    - task: PublishBuildArtifacts@1
